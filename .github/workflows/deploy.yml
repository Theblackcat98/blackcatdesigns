# Build static Next.js portfolio and push to builds branch
name: Build and Push Static Site

on:
  push:
    branches: [ main, master ]

# Set permissions for pushing to builds branch
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper branch operations
          fetch-depth: 0

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Type check
      - name: Type check
        run: npm run type-check

      # Build static Next.js application
      - name: Build static Next.js application
        run: npm run build

      # Verify static build output
      - name: Verify static build output
        run: |
          echo "Current directory contents:"
          ls -la
          echo ""
          echo "Checking for static build output:"
          if [ -d "out" ]; then
            echo "✅ out/ directory found!"
            echo "Contents of out/ directory:"
            ls -la out/
            echo "Static pages generated:"
            find out/ -name "*.html" | head -10
            echo ""
            echo "Total files in out/:"
            find out/ -type f | wc -l
          else
            echo "❌ out/ directory not found!"
            exit 1
          fi

      # Configure git for pushing to builds branch
      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # Commit and push static files to builds branch
      - name: Commit and push to builds branch
        run: |
          # Switch to builds branch (create if doesn't exist)
          git checkout builds 2>/dev/null || git checkout -b builds

          # Remove all files except .git and out/
          find . -maxdepth 1 ! -name ".git" ! -name "out" ! -name "." -exec rm -rf {} \; 2>/dev/null || true

          # Move out/ contents to root
          if [ -d "out" ]; then
            mv out/* . 2>/dev/null || true
            mv out/.[^.]* . 2>/dev/null || true
            rmdir out 2>/dev/null || true
          fi

          # Add all static files
          git add .

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Deploy static site - $(date '+%Y-%m-%d %H:%M:%S')"
            git push origin builds
            echo "✅ Static site deployed to builds branch"
          fi